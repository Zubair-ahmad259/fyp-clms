{% extends 'Home/base.html' %}
{% load static %}
{% block body %}
<div class="page-wrapper">
    <div class="content container-fluid">
            <div class="mb-3">
                {% for message in messages %}
                <div class="alert 
                            {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}

            </div>


        <!-- Page Header -->
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title">Students</h3>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                        <li class="breadcrumb-item active">Students</li>
                    </ul>
                </div>
                <div class="col-auto text-right float-right ml-auto">
                    <a href="{% url 'add_student' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Student
                    </a>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="row filter-row">
            <div class="col-sm-6 col-md-3">
                <div class="form-group form-focus">
                    <label class="focus-label">Discipline</label>
                    <select class="form-control" id="discipline_filter">
                        <option value="">All Disciplines</option>
                        {% for discipline in disciplines %}
                        <option value="{{ discipline.id }}" {% if selected_discipline and selected_discipline.id == discipline.id %}selected{% endif %}>
                            {{ discipline.field }} ({{ discipline.program }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Batch Filter -->
            <div class="col-sm-6 col-md-3">
                <div class="form-group form-focus">
                    <label class="focus-label">Batch</label>
                    <select class="form-control" id="batch_filter">
                        <option value="">All Batches</option>
                        {% for batch in batches %}
                        <option value="{{ batch.id }}" {% if selected_batch and selected_batch.id == batch.id %}selected{% endif %}>
                            {{ batch.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Section Filter -->
            <div class="col-sm-6 col-md-3">
                <div class="form-group form-focus">
                    <label class="focus-label">Section</label>
                    <select class="form-control" id="section_filter" {% if not selected_batch %}{% endif %}>
                        <option value="">All Sections</option>
                        {% for section in sections %}
                        <option value="{{ section.id }}" {% if selected_section and selected_section.id == section.id %}selected{% endif %}>
                            {{ section.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Semester Filter -->
            <div class="col-sm-6 col-md-3">
                <div class="form-group form-focus">
                    <label class="focus-label">Semester</label>
                    <select class="form-control" id="semester_filter">
                        <option value="">All Semesters</option>
                        {% for semester in semesters %}
                        <option value="{{ semester.id }}" {% if selected_semester and selected_semester.id == semester.id %}selected{% endif %}>
                            Semester {{ semester.number }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Filter Button -->
        <div class="row mb-3">
            <div class="col-md-12">
                <a href="#" class="btn btn-success btn-block" id="filter_button">Filter</a>
            </div>
        </div>

        <!-- Active Filters Indicator -->
        {% if selected_discipline or selected_batch or selected_section or selected_semester %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            Showing students:
            {% if selected_discipline %}<strong>Discipline: {{ selected_discipline.field }}</strong>{% endif %}
            {% if selected_batch %}<strong> Batch: {{ selected_batch.name }}</strong>{% endif %}
            {% if selected_section %}<strong> Section: {{ selected_section.name }}</strong>{% endif %}
            {% if selected_semester %}<strong> Semester: {{ selected_semester.number }}</strong>{% endif %}
            <a href="?" class="close" aria-label="Clear filter"><span aria-hidden="true">&times;</span></a>
        </div>
        {% endif %}

        <!-- Students Table -->
        <div class="row">
            <div class="col-sm-12">
                <div class="card card-table">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-center mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Student</th>
                                        <th>Father Name</th>
                                        <th>Discipline</th>
                                        <th>Batch</th>
                                        <th>Section</th>
                                        <th>Semester</th>
                                        <th>Contact</th>
                                        <th class="text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if students %}
                                    {% for student in students %}
                                    <tr>
                                        <td>{{ student.student_id }}</td>
                                        <td>
                                            <h2 class="table-avatar">
                                                <a href="{% url 'view_student' student.id %}" class="avatar avatar-sm mr-2">
                                                    {% if student.image %}
                                                        <img class="avatar-img rounded-circle" src="{{ student.image.url }}" alt="{{ student.first_name }}" width="40" height="40">
                                                    {% else %}
                                                        <img class="avatar-img rounded-circle" src="{% static 'assets/img/user.jpg' %}" alt="Default" width="40" height="40">
                                                    {% endif %}
                                                </a>
                                                <a href="{% url 'view_student' student.id %}">{{ student.first_name }} {{ student.last_name }}</a>
                                            </h2>
                                        </td>
                                        <td>{{ student.parent.father_name|default:"-" }}</td>
                                        <td>{{ student.discipline.field }}</td>
                                        <td>{{ student.batch.name }}</td>
                                        <td>{{ student.section.name }}</td>
                                        <td>Semester {{ student.semester.number }}</td>
                                        <td>{{ student.contact_number }}</td>
                                        <td class="text-right">
                                            <div class="actions">
                                                {% if student.semester.number < semesters|length %}
                                                <form action="{% url 'promote_student' student.id %}" method="POST" style="display:inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm bg-warning-light mr-2" title="Promote"
                                                        onclick="return confirm('Promote {{ student.first_name }} to the next semester?');">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </button>
                                                </form>
                                                {% endif %}
                                                <a href="{% url 'edit_student' student.id %}" class="btn btn-sm bg-success-light mr-2" title="Edit">
                                                    <i class="fas fa-pen"></i>
                                                </a>
                                                <form action="{% url 'delete_student' student.id %}" method="POST" style="display:inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm bg-danger-light" title="Delete"
                                                        onclick="return confirm('Are you sure you want to delete this student?');">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            {% if selected_discipline or selected_batch or selected_section or selected_semester %}
                                            No students found for selected filters
                                            {% else %}
                                            No students found. <a href="{% url 'add_student' %}">Add a student</a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Filter Script -->
<script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>

<script>
$(document).ready(function() {
    $('#filter_button').click(function(e) {
        e.preventDefault();
        var disciplineId = $('#discipline_filter').val();
        var batchId = $('#batch_filter').val();
        var sectionId = $('#section_filter').val();
        var semesterId = $('#semester_filter').val();

        var url = "{% url 'student_list' %}?";
        if (disciplineId) url += "discipline=" + disciplineId + "&";
        if (batchId) url += "batch=" + batchId + "&";
        if (sectionId) url += "section=" + sectionId + "&";
        if (semesterId) url += "semester=" + semesterId;

        window.location.href = url;
    });
});
</script>
{% endblock %}
