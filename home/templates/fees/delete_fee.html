{% extends "Home/base.html" %}
{% load static %}

{% block title %}Delete Fee Record - {{ fee.student.name }}{% endblock %}

{% block body %}

<div class="main-wrapper">
    <div class="page-wrapper">
        <div class="content container-fluid">
            <div class="row">
                <div class="col-md-8 mx-auto">
                    
                    <!-- Messages Display -->
                    {% if messages %}
                    <div class="alert-container mb-4">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            <i class="fas 
                                {% if message.tags == 'success' %}fa-check-circle{% endif %}
                                {% if message.tags == 'error' or message.tags == 'danger' %}fa-exclamation-circle{% endif %}
                                {% if message.tags == 'warning' %}fa-exclamation-triangle{% endif %}
                                {% if message.tags == 'info' %}fa-info-circle{% endif %}
                            "></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Delete Confirmation Card -->
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-trash-alt me-2"></i>Delete Fee Record
                            </h4>
                        </div>
                        <div class="card-body">
                            
                            <!-- Warning Alert -->
                            <div class="alert alert-danger border-danger">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-exclamation-triangle fa-2x me-3 mt-1"></i>
                                    <div>
                                        <h5 class="alert-heading">Warning!</h5>
                                        <p class="mb-2">You are about to permanently delete a fee record. This action cannot be undone.</p>
                                        <p class="mb-0"><strong>Please review the details below before proceeding.</strong></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Fee Details Card -->
                            <div class="card border-danger mb-4">
                                <div class="card-header bg-danger-light border-danger">
                                    <h5 class="mb-0 text-danger">
                                        <i class="fas fa-file-invoice-dollar me-2"></i>Fee Details to be Deleted
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Student Information</label>
                                                <div class="p-3 bg-light rounded">
                                                    <h6 class="mb-1">
                                                        <i class="fas fa-user-graduate me-2"></i>{{ fee.student.name }}
                                                    </h6>
                                                    <p class="mb-1">
                                                        <i class="fas fa-id-card me-2"></i>{{ fee.student.student_id }}
                                                    </p>
                                                    <p class="mb-0">
                                                        <i class="fas fa-envelope me-2"></i>{{ fee.student.email|default:"No email" }}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Academic Information</label>
                                                <div class="p-3 bg-light rounded">
                                                    <p class="mb-1">
                                                        <i class="fas fa-graduation-cap me-2"></i>{{ fee.discipline.field }} ({{ fee.discipline.program }})
                                                    </p>
                                                    <p class="mb-1">
                                                        <i class="fas fa-calendar-alt me-2"></i>Batch: {{ fee.batch.name }}
                                                    </p>
                                                    <p class="mb-1">
                                                        <i class="fas fa-chalkboard-teacher me-2"></i>Section: {{ fee.section.name }}
                                                    </p>
                                                    <p class="mb-0">
                                                        <i class="fas fa-book me-2"></i>Semester: {{ fee.semester.number }}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Fee Details</label>
                                                <div class="p-3 bg-light rounded">
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <div class="text-center p-2">
                                                                <div class="text-muted small">Semester Option</div>
                                                                <div class="h5 fw-bold">{{ fee.semester_option }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="text-center p-2 border-start">
                                                                <div class="text-muted small">Base Amount</div>
                                                                <div class="h5 fw-bold text-primary">
                                                                    <i class="fas fa-rupee-sign"></i>{{ fee.amount }}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="text-center p-2 border-start">
                                                                <div class="text-muted small">Fine Amount</div>
                                                                <div class="h5 fw-bold text-warning">
                                                                    <i class="fas fa-rupee-sign"></i>{{ fee.fine }}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="text-center p-2 border-start">
                                                                <div class="text-muted small">Total Amount</div>
                                                                <div class="h5 fw-bold text-success">
                                                                    <i class="fas fa-rupee-sign"></i>{{ fee.total_fee }}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row mt-3">
                                                        <div class="col-md-6">
                                                            <p class="mb-1">
                                                                <i class="fas fa-calendar-day me-2"></i>
                                                                <strong>Due Date:</strong> {{ fee.due_date|date:"d M, Y" }}
                                                            </p>
                                                            <p class="mb-0">
                                                                <i class="fas fa-calendar-plus me-2"></i>
                                                                <strong>Uploaded:</strong> {{ fee.upload_date|date:"d M, Y" }}
                                                            </p>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <p class="mb-1">
                                                                <i class="fas fa-info-circle me-2"></i>
                                                                <strong>Status:</strong> 
                                                                {% if fee.is_cleared %}
                                                                <span class="badge bg-success">Cleared</span>
                                                                {% else %}
                                                                <span class="badge bg-warning">Pending</span>
                                                                {% endif %}
                                                            </p>
                                                            {% if fee.clear_record %}
                                                            <p class="mb-0">
                                                                <i class="fas fa-calendar-check me-2"></i>
                                                                <strong>Cleared:</strong> {{ fee.clear_record.cleared_date|date:"d M, Y" }}
                                                            </p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Impact Warning -->
                                    <div class="alert alert-warning">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-exclamation-circle me-3 mt-1"></i>
                                            <div>
                                                <h6 class="alert-heading">Impact of Deletion</h6>
                                                <ul class="mb-0">
                                                    <li>This fee record will be permanently removed from the system</li>
                                                    <li>Any clearance records associated with this fee will also be deleted</li>
                                                    <li>This action will affect financial reports and student fee history</li>
                                                    <li>Deleted data cannot be recovered through normal means</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Deletion Confirmation -->
                            <div class="card border-warning">
                                <div class="card-header bg-warning-light border-warning">
                                    <h5 class="mb-0 text-warning">
                                        <i class="fas fa-shield-alt me-2"></i>Confirm Deletion
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form method="post" id="deleteForm">
                                        {% csrf_token %}
                                        
                                        <!-- Confirmation Checkboxes -->
                                        <div class="mb-4">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="confirmIrreversible" required>
                                                <label class="form-check-label" for="confirmIrreversible">
                                                    I understand that this action is <strong class="text-danger">irreversible</strong> and the data cannot be recovered
                                                </label>
                                            </div>
                                            
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="confirmResponsibility" required>
                                                <label class="form-check-label" for="confirmResponsibility">
                                                    I take full responsibility for deleting this fee record
                                                </label>
                                            </div>
                                            
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="confirmBackup" required>
                                                <label class="form-check-label" for="confirmBackup">
                                                    I have ensured that necessary backups are available if needed
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Reason for Deletion -->
                                        <div class="mb-4">
                                            <label for="deletionReason" class="form-label">
                                                <i class="fas fa-comment-dots me-2"></i>Reason for Deletion (Required)
                                            </label>
                                            <textarea class="form-control" id="deletionReason" name="deletion_reason" 
                                                      rows="3" placeholder="Please provide a reason for deleting this fee record..." 
                                                      minlength="10" required></textarea>
                                            <div class="form-text">
                                                This information will be logged for audit purposes.
                                            </div>
                                        </div>

                                        <!-- Deleting User Info -->
                                        <div class="alert alert-info">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user-shield fa-lg me-3"></i>
                                                <div>
                                                    <h6 class="alert-heading mb-1">Deletion Log</h6>
                                                    <p class="mb-0">
                                                        <strong>Deleting User:</strong> {{ request.user.get_full_name|default:request.user.username }}<br>
                                                        <strong>Timestamp:</strong> {% now "d M Y, H:i" %}<br>
                                                        <strong>IP Address:</strong> {{ request.META.REMOTE_ADDR }}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <a href="{% url 'fee_list' %}" class="btn btn-outline-secondary">
                                                    <i class="fas fa-arrow-left me-1"></i> Cancel & Return
                                                </a>
                                            </div>
                                            <div class="btn-group">
                                                {% if not fee.is_cleared %}
                                                <a href="{% url 'edit_fee' fee.id %}" class="btn btn-outline-warning">
                                                    <i class="fas fa-edit me-1"></i> Edit Instead
                                                </a>
                                                {% endif %}
                                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                                                    <i class="fas fa-trash-alt me-1"></i> Permanently Delete
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Quick Links -->
                            <div class="mt-4">
                                <h6 class="text-muted mb-3">
                                    <i class="fas fa-link me-2"></i>Quick Links
                                </h6>
                                <div class="d-flex flex-wrap gap-2">
                                    <a href="{% url 'student_fee_detail' fee.student.id %}" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-eye me-1"></i> View Student Fee Details
                                    </a>
                                    <a href="{% url 'fee_list' %}?batch={{ fee.batch.id }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-list me-1"></i> View Batch Fee List
                                    </a>
                                    {% if not fee.is_cleared %}
                                    <a href="{% url 'clear_fee' fee.id %}" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-check me-1"></i> Clear This Fee Instead
                                    </a>
                                    {% endif %}
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Final Confirmation Modal -->
<div class="modal fade" id="finalConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Final Confirmation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger mb-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-radiation fa-2x me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-2">Final Warning!</h5>
                            <p class="mb-0">You are about to permanently delete the fee record for <strong>{{ fee.student.name }}</strong>.</p>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">Deletion Summary</h6>
                        <ul class="mb-0">
                            <li><strong>Student:</strong> {{ fee.student.name }} ({{ fee.student.student_id }})</li>
                            <li><strong>Amount:</strong> Rs. {{ fee.amount }} + Rs. {{ fee.fine }} fine</li>
                            <li><strong>Total:</strong> Rs. {{ fee.total_fee }}</li>
                            <li><strong>Semester:</strong> {{ fee.semester_option }}</li>
                            <li><strong>Deleting User:</strong> {{ request.user.username }}</li>
                        </ul>
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <h6><i class="fas fa-history me-2"></i>No Undo Available</h6>
                    <p class="mb-0">Once deleted, this action cannot be reversed through the application interface.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <button type="submit" form="deleteForm" class="btn btn-danger">
                    <i class="fas fa-trash-alt me-1"></i> Yes, Delete Permanently
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom Styles */
    .card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
    }
    
    .card-header {
        border-radius: 10px 10px 0 0 !important;
        padding: 15px 20px;
    }
    
    .bg-danger-light {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }
    
    .bg-warning-light {
        background-color: rgba(255, 193, 7, 0.1) !important;
    }
    
    .border-danger {
        border: 1px solid rgba(220, 53, 69, 0.2) !important;
    }
    
    .border-warning {
        border: 1px solid rgba(255, 193, 7, 0.2) !important;
    }
    
    .alert {
        border-radius: 8px;
        border: none;
    }
    
    .alert-danger.border-danger {
        border: 1px solid rgba(220, 53, 69, 0.3) !important;
    }
    
    .alert-warning {
        background-color: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.2);
    }
    
    .alert-info {
        background-color: rgba(13, 110, 253, 0.1);
        border: 1px solid rgba(13, 110, 253, 0.2);
    }
    
    .form-check-input:checked {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    
    .form-control {
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }
    
    .form-control:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-outline-warning:hover {
        background-color: #ffc107;
        color: #212529;
    }
    
    .btn-outline-info:hover {
        background-color: #0dcaf0;
        color: white;
    }
    
    .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: white;
    }
    
    .btn-outline-success:hover {
        background-color: #198754;
        color: white;
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);
        border: none;
        transition: all 0.3s ease;
    }
    
    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }
    
    .btn-danger:disabled {
        background: #dc3545;
        opacity: 0.6;
        transform: none;
        box-shadow: none;
    }
    
    .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .bg-light {
        background-color: #f8f9fa !important;
    }
    
    .rounded {
        border-radius: 8px !important;
    }
    
    .border-start {
        border-left: 1px solid #dee2e6 !important;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .card-header h4 {
            font-size: 1.2rem;
        }
        
        .btn-group {
            flex-direction: column;
            width: 100%;
        }
        
        .btn-group .btn {
            margin-bottom: 10px;
            width: 100%;
        }
        
        .d-flex.flex-wrap {
            justify-content: center;
        }
        
        .d-flex.flex-wrap .btn {
            margin-bottom: 10px;
            width: 100%;
        }
        
        .col-md-3 .border-start {
            border-left: none !important;
            border-top: 1px solid #dee2e6 !important;
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .alert .d-flex {
            flex-direction: column;
            text-align: center;
        }
        
        .alert i {
            margin-bottom: 10px;
            margin-right: 0 !important;
        }
    }
    
    /* Animation for disabled button */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    
    .btn-danger:not(:disabled):hover {
        animation: pulse 0.3s ease;
    }
    
    /* Styling for form checkboxes */
    .form-check {
        padding-left: 2.5em;
    }
    
    .form-check-input {
        width: 1.2em;
        height: 1.2em;
        margin-left: -2.5em;
        margin-top: 0.2em;
    }
    
    .form-check-label {
        padding-top: 0.1em;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get elements
    const confirmIrreversible = document.getElementById('confirmIrreversible');
    const confirmResponsibility = document.getElementById('confirmResponsibility');
    const confirmBackup = document.getElementById('confirmBackup');
    const deletionReason = document.getElementById('deletionReason');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const finalConfirmModal = new bootstrap.Modal(document.getElementById('finalConfirmModal'));
    const deleteForm = document.getElementById('deleteForm');
    
    // Function to check if all conditions are met
    function checkConditions() {
        const allChecked = confirmIrreversible.checked && 
                          confirmResponsibility.checked && 
                          confirmBackup.checked;
        const reasonValid = deletionReason.value.trim().length >= 10;
        
        confirmDeleteBtn.disabled = !(allChecked && reasonValid);
    }
    
    // Add event listeners to checkboxes and textarea
    [confirmIrreversible, confirmResponsibility, confirmBackup].forEach(checkbox => {
        checkbox.addEventListener('change', checkConditions);
    });
    
    deletionReason.addEventListener('input', function() {
        checkConditions();
        // Show character count
        const length = this.value.trim().length;
        const minLength = 10;
        
        if (length < minLength) {
            this.style.borderColor = '#dc3545';
            this.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
        } else {
            this.style.borderColor = '#198754';
            this.style.boxShadow = '0 0 0 0.2rem rgba(25, 135, 84, 0.25)';
        }
    });
    
    // Handle delete button click
    confirmDeleteBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Validate reason length
        if (deletionReason.value.trim().length < 10) {
            alert('Please provide a reason for deletion (minimum 10 characters).');
            deletionReason.focus();
            return;
        }
        
        // Show final confirmation modal
        finalConfirmModal.show();
    });
    
    // Handle form submission
    deleteForm.addEventListener('submit', function(e) {
        // Add timestamp to form data
        const timestampField = document.createElement('input');
        timestampField.type = 'hidden';
        timestampField.name = 'deletion_timestamp';
        timestampField.value = new Date().toISOString();
        this.appendChild(timestampField);
        
        // Add user info
        const userField = document.createElement('input');
        userField.type = 'hidden';
        userField.name = 'deleting_user';
        userField.value = '{{ request.user.username }}';
        this.appendChild(userField);
        
        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Deleting...';
        submitBtn.disabled = true;
        
        // Allow form to submit
        return true;
    });
    
    // Warn user if they try to leave the page
    let formChanged = false;
    
    deletionReason.addEventListener('input', function() {
        formChanged = this.value.trim().length > 0;
    });
    
    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        }
    });
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Auto-check for debugging (remove in production)
    {% if debug %}
    console.log('Debug mode: Auto-filling form for testing');
    setTimeout(() => {
        confirmIrreversible.checked = true;
        confirmResponsibility.checked = true;
        confirmBackup.checked = true;
        deletionReason.value = 'Testing deletion in debug mode. This is a test reason for deleting the fee record.';
        checkConditions();
    }, 1000);
    {% endif %}
});
</script>

{% endblock %}