{% extends "Home/base.html" %}
{% load static %}

{% block body %}
<div class="page-wrapper">
<div class="content container-fluid">

<h3>Upload Student Fees</h3>

<!-- Single form wrapper -->
<form method="post" id="feeUploadForm">
{% csrf_token %}

<div class="row mb-3">
    <div class="col-md-3">
        <label class="form-label"><i class="fas fa-graduation-cap me-1"></i> Discipline</label>
        <select name="discipline" class="form-select form-select-sm" id="disciplineSelect" required>
            <option value="">Select Discipline</option>
            {% for disc in disciplines %}
            <option value="{{ disc.id }}" {% if selected_discipline == disc.id|stringformat:"s" %}selected{% endif %}>
                {{ disc.field }} ({{ disc.program }})
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="col-md-3">
        <label class="form-label"><i class="fas fa-calendar-alt me-1"></i> Batch</label>
        <select name="batch" class="form-select form-select-sm" id="batchSelect" required>
            <option value="">Select Batch</option>
            {% for b in batches %}
            <option value="{{ b.id }}" 
                    data-discipline="{{ b.discipline.id }}"
                    {% if selected_batch == b.id|stringformat:"s" %}selected{% endif %}>
                {{ b.name }}-{{ b.discipline.program }}{{ b.discipline.field }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="col-md-3">
        <label class="form-label"><i class="fas fa-book-open me-1"></i> Semester</label>
        <select name="semester" class="form-select form-select-sm" id="semesterSelect" required>
            <option value="">Select Semester</option>
            {% for sem in semesters %}
            <option value="{{ sem.id }}" {% if selected_semester == sem.id|stringformat:"s" %}selected{% endif %}>
                Semester {{ sem.number }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="col-md-3">
        <label class="form-label"><i class="fas fa-users me-1"></i> Section</label>
        <select name="section" class="form-select form-select-sm" id="sectionSelect" required>
            <option value="">Select Section</option>
            {% for s in sections %}
            <option value="{{ s.id }}" 
                    data-batch="{{ s.batch.id }}"
                    {% if selected_section == s.id|stringformat:"s" %}selected{% endif %}>
                {{ s.name }}
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<hr>

<div class="row mb-3">
    <div class="col-md-4">
        <label>Tuition Fee</label>
        <input type="number" name="amount" class="form-control" value="{{ request.POST.amount|default:'0' }}" required min="0" step="0.01">
    </div>
    
    <div class="col-md-4">
        <label>Due Date</label>
        <input type="date" name="due_date" class="form-control" value="{{ default_due_date }}" required>
    </div>
    
    <div class="col-md-4">
        <label>Grace Period Days</label>
        <input type="number" name="grace_period" class="form-control" value="5" min="0">
    </div>
</div>

<button type="submit" name="load_students" class="btn btn-primary">
    <i class="fas fa-search"></i> Load Students
</button>

<!-- Add a hidden field to track which button was clicked -->
<input type="hidden" name="action" id="actionField" value="">

{% if students %}
<hr>
<h5>Students Found: {{ students|length }}</h5>

<table class="table table-bordered mt-3">
    <thead>
        <tr>
            <th>#</th>
            <th>Student ID</th>
            <th>Student Name</th>
            <th>Tuition Fee</th>
        </tr>
    </thead>
    
    <tbody>
        {% for student in students %}
        <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ student.student_id }}</td>
            <td>{{ student.first_name }} {{ student.last_name }}</td>
            <td>
                <input type="number"
                       name="base_amount_{{ student.id }}"
                       value="{{ request.POST.amount|default:'0' }}"
                       class="form-control fee-input"
                       min="0"
                       step="0.01"
                       required>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="4" class="text-center">No students found for the selected criteria</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<button type="submit" name="submit_all" class="btn btn-success mt-2">
    <i class="fas fa-upload"></i> Upload Fees
</button>
{% endif %}

</form>

</div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('feeUploadForm');
    const actionField = document.getElementById('actionField');
    
    // Handle which button was clicked
    form.querySelectorAll('button[type="submit"]').forEach(button => {
        button.addEventListener('click', function(e) {
            actionField.value = this.name;
        });
    });
    
    // Filter dependencies
    const disciplineSelect = document.getElementById('disciplineSelect');
    const batchSelect = document.getElementById('batchSelect');
    const sectionSelect = document.getElementById('sectionSelect');
    
    // Filter batches based on discipline
    if (disciplineSelect) {
        disciplineSelect.addEventListener('change', function() {
            const selectedDisciplineId = this.value;
            const batchOptions = batchSelect.querySelectorAll('option');
            
            batchOptions.forEach(option => {
                if (option.value === '') return; // Keep "Select Batch" option
                
                if (selectedDisciplineId === '' || 
                    option.getAttribute('data-discipline') === selectedDisciplineId) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Reset batch and section if discipline changes
            batchSelect.value = '';
            sectionSelect.value = '';
        });
    }
    
    // Filter sections based on batch
    if (batchSelect) {
        batchSelect.addEventListener('change', function() {
            const selectedBatchId = this.value;
            const sectionOptions = sectionSelect.querySelectorAll('option');
            
            sectionOptions.forEach(option => {
                if (option.value === '') return; // Keep "Select Section" option
                
                if (selectedBatchId === '' || 
                    option.getAttribute('data-batch') === selectedBatchId) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Reset section if batch changes
            sectionSelect.value = '';
        });
    }
    
    // Validate form before loading students
    form.addEventListener('submit', function(e) {
        if (actionField.value === 'load_students') {
            const requiredFields = ['discipline', 'batch', 'semester', 'section'];
            let isValid = true;
            
            requiredFields.forEach(fieldName => {
                const field = form.querySelector(`[name="${fieldName}"]`);
                if (!field.value) {
                    isValid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('Please select all required fields (Discipline, Batch, Semester, Section)');
            }
        }
    });
    
    // Initialize filters on page load
    if (disciplineSelect && disciplineSelect.value) {
        disciplineSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}